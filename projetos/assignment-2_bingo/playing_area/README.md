# Run
```
python3.10 playing_area.py
```

# Documentation
## States
The playing area is divided in 6 states.

	 IDLE
	 WAITING
	 SUBMIT_CARD
	 SUBMIT_DECK
	 SUBMIT_KEYS
	 SHARE_WINNERS
	 AUDIT

### IDLE
This state is active if and only if there aren't any clients connected (caller and players).

### WAITING
When the caller is connected and he didn't started the game yet.

### SUBMIT_CARD
This state is triggered when the caller starts the game, it's focused on sharing the cards generated by the players.

### SUBMIT_DECK
After all users submit their cards, this state is automatically triggered, it's purpose is to shuffle the decks. The caller sends it's deck encrypted and then each player following their order of registration (sequence number) shuffle the last deck broadcasted and generates a new shuffle.

### SUBMIT_KEYS
This state is achieved when the caller uses the call `start_send_keys` (see below). It lasts until all players share their symmetric keys used to encrypt the deck.

### SHARE_WINNERS
This state is dedicated to announce the winner, everyone broadcasts it's outcome (including the caller). If the outcome is different from the one generated by the caller, the player is disqualified.


### AUDIT
After the SHARE_WINNERS state is completed, the playing area enters in AUDIT state, this state dedicated to ask for logs from the playing area.

If the caller disconnects, the playing area closes all connections with the players and enters in IDLE state.

## API

All API's request/responsed format's are passed through a JSON object.

### Message Repetition / collision avoidance
All API calls allow message repetition / collision avoidance through a special field called `UUID`, this field is a random number generated by the sender of the message, it has the property that given two messages (originated by the users) with same `UUID` it implies that they are both equal, this property enables fast message repetition check in O(1). Also, the `UUID` field is copied into the response of a request. 

There's two benefits of this approach
* Debugging purposes, a sender who wrongly sends two repeated messages is easily indentified.
* Avoid request collisions

#### Generic request format
```
{'type' : str , ... , 'UUID' : float | uuid} -> PA
```

* `type` is the call identification (login etc ...).
* `UUID` random number or uuid generated by the user in order to assign an id to the call (useful to avoid broadcast / request collisions).
* `...` any other fields imposed by the call.


#### Generic response format
```
{'status' : int , 'info' : str , 'UUID': float | uuid, ...} -> destination
```

* `status` is the status code of the call, the list of codes are defined below.
* `UUID` field sent in request.
* `info` contains a message that specifies additional information about the `status` field (this field is not mandatory, it may not appear in some calls).
* `...` any other fields sent by the specified call.
* `destination` is used to define for whom the message will be sent. It can assume the following values:
	* `none` : No one receives the response, this may happen in messages that never produce any response. (1:0)
	* `sender`: The client who produced the original message receives the response (1:1)
	* `all`: Everyone will receive the response include the sender (1:all)
	* `all_except_sender`: Everyone except the sender will receive the message 


#### Status codes
Each message returns a status code indicating it's status.
| Code | Description |
| :---: | :---: |
| 0 | Success |
| 1 | Invalid request format |
| 2 | Invalid request parameter|
| 3 | Aldready exists|
| 4 | invalid operation in current state|
| 5 | invalid permissions|
| 6 | invalid operation in current context|

Note: The only valid code is 0.



### Get nonce
This call is used whenether a user needs a nonce message from the server in order to login.
#### Request format
```
{'type' : 'get_nonce' , 'pubkey' : str , 'certificate' : str} -> sender
```

* `certificate` field is optional if the user isn't using a citizien card, if this field is present, pubkey cannot be used.

#### Valid response format
```
{'code' : 0 , 'nonce' : str , 'type' : 'get_nonce'} -> sender
```
#### Invalid responses
```
{'code' : 1 , 'type' : 'get_nonce' , 'info' : 'Received both "certificate" and "pubkey" fields, only one of them is expected'} -> sender
```
```
{'code' : 1 , 'type' : 'get_nonce', 'info' : 'Expected "certificate" or "pubkey" field'} -> sender
```
```
{'code' : 4 ,'type' : 'get_nonce' , 'info' : 'This call only works in "IDLE" or "WAITING" states'} -> sender
```
```
{'code' : 2 , 'type' : 'get_nonce' , 'info' : 'Invalid certificate'} -> sender
```

### Enter playing area (login)
#### Description
 This call should be used whenever a player or a caller want to join the playing area. 
#### Request format
```
{'type' : 'login' , 'role' : str , 'nonce' : str, 'nick' : str , 'pubkey' : str} -> PA
```
* If the user isn't a using citizien card, the field `pubkey` is not necessary (the public key sent in `get_nonce` will be chosen), on the other hand if the user is using a citizien card, the public key field is mandatory.
* `role` can be `player` or `caller`

#### Valid response format
```
{'code' : 0 , 'role' : str , 'seq': int , 'type' : 'login' ,  'pubkey' : str , 'max_players' : int , 'N' : int} -> sender
```

```
{'type' : 'new_client' , 'seq' : int , 'nick' : str , 'pubkey' : str} -> all_except_sender
```

#### Invalid responses
```
{'code' : 2 , 'info' : 'Invalid nonce'} -> sender
```
```
{'code' : 4 , 'info' : "Login only works in 'IDLE' or 'WAITING' state"} -> sender
```

```
{'code' : 4 , 'info' : 'the first user must be a "caller"'} -> sender
```

```
{'code' : 4 , 'info' : 'Caller has aldready been registered'} -> sender
```

### Get users list (get_users_list)
#### Description
Returns the current list of users (players and caller)

#### Request format
```
{'type' : 'get_users_list'} -> PA
```

#### Valid response format
```
{'code' : 0 , 'users' : list[User]} -> sender
```

* `User` is a dictionary containing the following fields:
	* `seq: int`    : sequence number
	* `nick: str`   : user nick
	* `pubkey: str` : user public key


### Get audit log (get_audit_log)
#### Description
Returns the log of the calls.

#### Request format
```
{'type' : 'get_audit_log'} -> PA
```
#### Valid response format
```
{'code' : 0 , 'log' : list[Log]}
```

* `Log` is a dictionary containing the following fields:
	* `seq: int`    	 : sequence number of the user who produced the call.
	* `hash_prev: str`   : hash of the previus row, this field has the value `"0"` for the first log.
	* `timestamp: float` : timestamp when the log ocurred.
	* `text: str`		 : A string representation of the JSON produced.
	* `signature: base64`: Signature of the `text` converted into `utf-8` format field, signed by the playing area.

### Start game (start_game)
#### Description
Used by the caller to start the game.

#### Request format
```
{'type' : 'start_game'} -> PA
```

#### Valid response format
```
{'code' : 0 , 'type' : 'game_started'} -> all
```

#### Invalid responses

```
{'code' : 4, 'info': 'Start game call only works in "WAITING" state'} -> sender
```

```
{'code': 5 , 'info': 'A player cannot start a game'} -> sender
```

### Submit card (submit_card)
#### Description
Used by the players to broadcast their encrypted cards.

#### Request format
```
{'type' : 'submit_card' , 'card' : list[str]} -> PA
```

#### Valid response format
```
{'code': 0 , 'type' : 'submit_card' , 'info' : 'Player sucessfully sent his card' , 'seq': seq_n , 'card' : list[str]} -> all
```

#### Invalid responses
```
{'code' : 3 , 'info' : 'You aldready submitted your card'} -> sender
```

```
{'code': 4 ,'info' : 'This call is restricted to "SUBMIT_CARD" state'} -> sender
```

```
{'code': 5 , 'info' : 'Only players can submit cards'} -> sender
```

### Submit deck (submit_deck)
#### Description
Used by the players and the caller to submit their shuffled decks.

#### Request format
```
{'type' : 'submit_deck' , 'deck' : list[str]} -> PA
```

#### Valid response format
```
{'code': 0 , 'type' : 'submit_deck' , 'info' : 'Player sucessfully shuffled the deck' , 'seq': seq_n , 'deck' : list[str]} -> all
```

#### Invalid responses
```
{'code' : 5 , 'info' : 'This call is restricted to "SUBMIT_DECK" state'} -> sender
```

```
{'code': 5 , 'info' : 'Wait for your turn to send the deck'} -> sender
```

### Start send keys (start_send_keys)
#### Description
Used by the caller to start sending keys process.

#### Request format
```
{'type' : 'start_send_keys'} -> PA
```

#### Valid response format
```
{'code': 0 , 'type' : 'start_send_keys'} -> all
```

#### Invalid responses
```
{'code' : 5 , 'info' : "sendKeys can only be sent by the caller"} -> sender
```

```
{'code' : 4 , 'info' : "Send keys only works in 'SUBMIT_DECK' state"} -> sender
```

```
{'code' : 4 , 'info' : "Wait for all users send their shuffled decks"} -> sender
```


### Send keys (send_keys)
#### Description
Used to broadcast a key.

#### Request format
```
{'type' : 'send_keys' , key : str} -> PA
```

#### Valid response format
```
{'code': 0, 'type' : 'send_keys' , 'info' : "Sucessfully received key" , 'key' : str , 'seq' : seq} -> all
```

#### Invalid responses
```
{'code' : 4 , 'info' : "the caller didn't called 'start_send_keys' yet"}-> sender
```

```
{'code' : 3 , 'info' : 'You aldready broadcasted your key'} -> sender
```

### Ban player (ban_player)
#### Description
Used by the caller in order to ban a player.
#### Request format
```
{'type' : 'ban_player' , 'info' : str , 'seq' : int} -> PA
```

#### Valid response format
```
{'code' : 0 , 'type' : 'ban_player' , 'seq': int , 'info' : str} -> all
```

#### Invalid responses
```
{'code' : 5 , 'info' : 'This call is restricted to the caller'} -> sender
```

```
{'code' : 4 , 'info' : "You can't ban yourself"} -> sender
```

```
{'code' : 4 , 'info' : 'Invalid sequence number'} -> sender
```

```
{'code' : 5 , 'info': 'something went wrong removing the client'} -> sender
```

### Share winner (share_winner)
#### Description
Used by the caller and the players to share the outcome.
The caller can only share his outcome after all players share their outcome. Before the caller shares his outcome he must ban all players who sent wrong outcomes.

#### Request format
```
{'type' : 'share_winner' , 'winner' : list[int]} -> PA
```

#### Valid response format
```
{'code' : 0 , 'type' : 'share_winner' , 'seq': int , winner : list[int]} -> all
```

#### Invalid responses

```
{'code' : 4 , 'type' : 'share_winner' , 'info' : 'This call is restricted to "END_GAME" state'} -> sender
```

```
{'code' : 6 , 'type' : 'share_winner' , 'info' : 'The caller must wait for all players send their outcome'} -> sender
```

```
{'code' : 3 , 'type' : 'share_winner' , 'info' : 'You aldready submitted your outcome.'} -> sender
```

### Abort game (abort_game)
Used by the caller to end the game. All players are disconnected and playing area entres in "IDLE" state.

#### Request format
```
{'type' : 'abort_game' , 'info' : str} -> PA
```

#### Valid response format
```
{'code' : 0 , 'type' : 'abort_game' , 'info' : str} -> all
```

#### Invalid responses

```
{'code' : 5 , 'type' : 'abort_game' , 'info' : 'This call is restricted to the caller'} -> sender
```

```
{'code' : 4 , 'type' : 'abort_game' , 'info' : "This call doesn't work in 'IDLE' state or 'WAITING' state"} -> sender
```
